# Отчёт по исследованию мошеннических транзакций
---
## 1. Задачи и данные

### Цели исследования
- Понять закономерности поведения как легитимных, так и мошеннических транзакций.  
- Проверить набор продуктовых и технических гипотез для обнаружения fraud.  
- Построить поведенческие фичи и скор-карту/правила для антифрод-системы.  
- Провести кластеризацию операций и клиентов, выделить подозрительные сегменты.  
- Оценить взаимодействия признаков и построить простую интерпретируемую модель (scorecard / rules).

### Данные

#### Основной файл: `transaction_fraud_data.parquet`
Анонимизированный набор реальных финансовых транзакций с меткой `is_fraud`. Ключевые признаки:
- Идентификаторы: `transaction_id`, `customer_id`, `card_number`, `device_fingerprint`, `ip_address`
- Сумма/валюта/гео: `amount` (нормализованная в USD), `currency`, `country`, `city`, `city_size`, `is_outside_home_country`
- Контекст: `vendor_category`, `vendor_type`, `vendor`, `channel`, `device`, `card_type`, `is_card_present`
- Временной и поведенческий: `timestamp`, `last_hour_activity` (вложенная структура: `num_transactions`, `total_amount`, `unique_merchants`, `unique_countries`, `max_single_amount`)
- Другие: `is_high_risk_vendor`, `is_weekend`, `is_fraud`

#### Вспомогательный файл: `historical_currency_exchange.parquet`
Исторические курсы обмена (относительно USD) для конвертации сумм в единую валюту.

---

## 2. Первичный разведочный анализ (EDA) и итоги

**Что сделано:**
- Распределения по странам, типам карт, категориям вендоров, устройствам, каналам, размерам городов, присутствию карты, географии (вне страны), суммам.  
- Визуализация fraud vs legit для ключевых категорий (барплоты, boxplot, теплокарты, violin и пр.).  
- Оценка базовых зависимостей (fraud-rate по странам, по типу карты, устройству и т.п.).

**Ключевые наблюдения:**
- **География:** операции вне домашней страны резко повышают риск; в сочетании с «скачком» страны в пределах часа — ещё сильнее. Особенно выделяются 4 страны: Россия, Мексика, Бразилия и Нигерия (и их же валюты).
- **Суммы:** U-образный риск — очень маленькие (`≤ $1`) (тесты карт) и очень крупные (`> $10k`) операции подозрительны.  
- **Тип карты / категория вендора:** сами по себе слабо различают fraud (например, `card_type` и `vendor_category` дают мало сигнала, `is_high_risk_vendor` — несущественен). Мошеннические операции практически равномерно распределены между категориями, типами категорий и типами карт.  
- **Устройство и fingerprint:** уникальные device_fingerprint (встречаются один раз) почти всегда ассоциированы с fraud, в то время как "многоразовые" устройства — безопасны.  
- **Канал:** web и операции вне страны/ночью значительно повышают risk.  
- **Новые клиенты:** небольшое увеличение fraud у аккаунтов ≤30 дней.  
- **POS / prox-устройства:** артефакты (все транзакции — fraud) риск leakage или симуляции; нельзя слепо использовать без проверки, иначе модель будет переобучаться. Для этих данных будет прямая корреляция между fraud и значением столбцов.

---

## 3. Что можно не использовать и риски

**Неинформативные / опасные признаки:**
| Признак | Почему можно убрать / риски |
|--------|-----------------------------|
| `vendor_category`, `vendor_type` | Слабая дифференциация риска, большой шум |
| `card_type` | Не влияет на fraud существенно; может использоваться только как тариф/идентификатор, но не как риск-признак |
| `is_high_risk_vendor` | Практически нет эффекта (χ²-проверка незначима) |
| `prox`-устройства (NFC, Magnetic Stripe, Chip Reader) и POS | В датасете все такие транзакции помечены как fraud — риск leakage, создаёт «легкие» правила, но не отражает реальный поток |
| Слабые признаки без транзакционной истории (например, необработанные `last_hour_activity` без правильной синхронизации) | Возможны утечки, если неправильно агрегировать |

**Риски:**
- **Leakage:** явные или косвенные признаки, коррелирующие с меткой (например, artifactual `device`/`channel` в симуляции).  
- **Стабильность:** признаки вроде `fp_unique` могут в реальных данных иметь непустую долю уникальных легитимных устройств, нужно делать постоянную валидацию.

---

## 4. Тестирование гипотез

### Подтверждённые гипотезы (положительные)

1. **ticket_ratio > ~4×** (сравнение суммы со средним чеком клиента) — сильный сигнал fraud.  
2. **Сумма сильно отклоняется от среднего по категории** — повышенный риск.  
3. **Новый fingerprint (fp_unique)** — каждая четвертая fraud-транзакция с уникальным fingerprint; крайне сильный сигнал.  
4. **Geo-jump + за границей** — резкая смена страны в пределах часа и операция вне домашнего региона → fraud-rate ≈55%.  
5. **Дорогая CNP-операция за рубежом** — fraud ≈70% (комбинация amount > threshold, card_not_present, outside_home_country).  
6. **Новое устройство + дорогая покупка** — почти 94% fraud для комбинации `fp_age==0` и крупной суммы (>1000 USD).  
7. **U-образный риск по сумме** — экстремально маленькие и большие суммы опасны.  
8. **Ночная активность** усиливает многие сигналы (сочетание с high_ticket_ratio и гео).  

### Отвергнутые / слабые гипотезы (отрицательные)

1. **Количество типов карт у клиента** — не влияет на fraud-rate (χ²-p ≈1.0).  
2. **Shared IP как отдельный сигнал** — нет значимой разницы fraud-rate между уникальными и shared IP (χ²-п = 0.846).  
3. **Burst на уровне устройства** (всплеск транзакций за час) — не является однозначным индикатором мошенничества.  
4. **Отношение max_single_amount / total_amount за час** (одна большая среди мелких) — распределения fraud и legit перекрываются, сигнал слаб.  
5. **Card-testing → big** (первичная формулировка с 3 подряд small и затем крупной) — в исходной выборке не нашлось таких последовательностей, понадобилось ослабить условия или пересмотреть логику.

---

## 5. Кластеризация

### Кластеризация транзакций
- Применялись KMeans по набору поведенческих фич.  
- Получено несколько кластеров; среди них выделяются high-risk кластера с fraud-rate ~78–100% (например, кластеры 0, 3, 4).  
- Профили кластеров показали, что высокие кластера отличаются по:  
  - `fp_unique`,  
  - `ticket_ratio`,  
  - гео-флагам (`is_outside_home_country`, `geo_jump_flag`),  
  - `rule_551` и др.

---

## 6. Инженерия признаков (feature engineering)

### Основные фичи и смысл
| Признак | Что показывает |
|--------|----------------|
| `ticket_ratio` / `high_ticket_ratio` | Насколько текущая сумма превышает средний чек клиента |
| `fp_unique` | Уникальный fingerprint (одноразовое устройство) |
| `rule_551` | Дорогая CNP-операция за рубежом |
| `geo_jump_flag` | Внезапная смена страны + операция вне дома в пределах 1 часа |
| `flag_new_expensive` | Новое устройство + дорогая покупка |
| `is_night` | Ночная транзакция (0–4) |
| `is_burst` | Очень короткая пауза до предыдущей операции клиента |
| `extreme_low_amt` / `extreme_high_amt` | Микро и сверхкрупные суммы |
| `skim_flag` | Один IP+device обслуживает >1 карт — признак возможного скимминга |
| `is_outside_home_country` | Транзакция вне домашней страны |
| `is_high_risk_country` | Горячие страны (Mexico, Russia, Brazil, Nigeria) |

### Итоги
- Большинство сильных сигналов пришли из комбинаций этих фич, а не из базовых сырых колонок.  
- Созданы составные флаги и взаимодействия, усиливающие discriminative power.  
- Признаки не требуют сложного внешнего обогащения и могут считаться онлайн с корректным хранением истории.

---

## 7. Дополнительное тестирование гипотез

- **Interaction heatmaps:**  
  1. `high_ticket_ratio × is_outside_home_country` с разбиением по ночи — выявлено, что ночью и за границей дорогие транзакции почти всегда мошеннические (~98%).  
  2. `fp_unique × rule_551` с фацетом по `skim_flag` — `fp_unique` доминирует, даёт 100% fraud; `rule_551` имеет добавочную ценность только при non-unique fp.  
  3. `geo_jump_flag × is_night` по горячим странам — комбинация дает экстремальный риск (до ~87%).  
  4. `flag_new_expensive × fp_unique` — новые дорогие покупки дают высокий риск, особенно если fingerprint уникален.

- **Card-testing** (ослабленные условия) — не нашлось достаточного количества явных паттернов с последовательностью small→small→big, можно переработать критерии (например, ≥2 мелких перед крупной, расширенное окно по времени).

---

## 8. Построение скор-карты и наборов фич

### Выбранные топ-5 драйверов 
1. `fp_unique`  
2. `flag_new_expensive`  
3. `rule_551`  
4. `geo_jump_flag`  
5. `high_ticket_ratio`

### Подход
- Логистическая регрессия на этих признаках (стандартизированных) как интерпретируемая скор-карта.  
- Предсказанная вероятность преобразуется в score / log-odds.  

### Итог
- Наличие сильного ранжирования: небольшая доля транзакций с высоким score покрывает большую часть fraud.  
- Можно комбинировать в правила: `if fp_unique OR (flag_new_expensive AND is_outside_home_country AND is_night) → manual review / block`.

---

## 9. Общие результаты (технические и продуктовые)

### Технические
- Определены сильные независимые и взаимодействующие фичи, которые дают резкий прирост в распознавании fraud.  
- Неполезные и опасные признаки идентифицированы (снижение шума, исключение leakage).  

### Продуктовые
- Правила с высокой точностью:  
  * `fp_unique` → стоп/ручная проверка.  
  * `new device + expensive` → step-up / подтверждение.  
  * `geo_jump_flag` + ночь + горячая страна → усиленная верификация.  
  * `rule_551` → приоритетное расследование.  
- Динамическая градация риска (комбинации → уровни: low / medium / high / critical).  
- Предложена логика для user journey: проверка 2FA, manual review, автоматический блок.

---

## 10. Рекомендации

### Что внедрить в первую очередь
1. **Фичи/правила высокого приоритета:**  
   - `fp_unique` как стоп-флаг.  
   - `rule_551` (дорогая CNP-за рубежом) как высокий риск.  
   - `geo_jump_flag` в сочетании с `is_night` и горячей страной.  
   - `high_ticket_ratio` вне страны, особенно ночью.  
   - `flag_new_expensive` (новое устройство + крупная сумма).  

2. **Scorecard / скоринг:** на основе топ-5 фичей; использовать для фильтрации и приоритезации исследования.  

3. **Interaction rules:** составные флаги (например, `high_ticket_ratio & outside & night`).

4. **Кластеризация:** использовать метку принадлежности к high-risk кластерам как дополнительный флаг.

5. **Мониторинг:** drift по ключевым фичам (`ticket_ratio`, `fp_unique`, `geo_jump_flag`).  

### Что убрать / осторожно использовать
- Признаки с потенциальным leakage (prox устройства, расхождения в симулированных сегментах).  
- Признаки с малым эффектом без контекста (например, `card_type.  

---

## 11. Что можно сделать в будущем

### Новые направления
- **Графовый анализ:** связи `device ↔ card ↔ ip`.  
- **Поведенческая последовательность:** n-gram модели или Markov для действий клиента (например, pattern mining в последовательностях).  
- **Time-based cross-validation:** устойчивость моделей во времени.  

### Инструментальные улучшения
- Автоматизированное обновление списка стран с высоким риском.  
- Персонализированные распределения по сегментам клиентов (low-value vs high-value, новые vs старые).
---

## Заключение

Исследование выстроило pipeline от первичного анализа до интерпретируемых сигналов и кластеров. Сочетание простых, но мощных признаков (`fp_unique`, `rule_551`, `geo_jump_flag`, `ticket_ratio`) с комбинациями обеспечивает высокое покрытие мошеннических операций при разумной точности. 



